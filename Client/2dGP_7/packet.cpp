#include "Packet.h"

Packet::Packet() : x(0), y(0) {
    state[0] = 0;
    state[1] = 0;
}

void Packet::setPosition(float xPos, float yPos) {
    x = xPos;
    y = yPos;
}

// 준비 완료 여부 설정 (7번째 비트)
void Packet::setReady(bool ready) {
    if (ready) state[0] |= 0x80;
    else state[0] &= ~0x80;
}

// 게임 시작 여부 설정 (6번째 비트)
void Packet::setGameStart(bool start) {
    if (start) state[0] |= 0x40;
    else state[0] &= ~0x40;
}

// 플레이어 번호 설정 (Valid 비트 1비트 + Number 비트 2비트: 5, 4, 3번째 비트)
void Packet::setPlayerNumber(uint8_t playerNumber) {
    state[0] = (state[0] & 0xC7) | ((playerNumber & 0x07) << 3);
}

// 플레이어 번호 유효성 설정 (Valid 비트만 설정, 5번째 비트)
void Packet::setPlayerNumberValid(bool valid) {
    if (valid) state[0] |= 0x20;
    else state[0] &= ~0x20;
}

// 아이템 보유 여부 설정 (2번째 비트)
void Packet::setItemPossession(bool hasItem) {
    if (hasItem) state[0] |= 0x04;
    else state[0] &= ~0x04;
}

// 아이템 적용 여부 설정 (1번째 비트)
void Packet::setItemApplied(bool itemApplied) {
    if (itemApplied) state[0] |= 0x02;
    else state[0] &= ~0x02;
}

// HP 설정 (0번째 비트)
void Packet::setHp(bool hp) {
    if (hp) state[0] |= 0x01;
    else state[0] &= ~0x01;
}

// 현재 바라보는 방향 설정 (state[1]의 1, 0번째 비트)
void Packet::setFacingDirection(uint8_t direction) {
    state[1] = (state[1] & 0xFC) | (direction & 0x03);
}



// 장애물 시드 설정 (state[1]의 7, 6번째 비트)
void Packet::setObstacleSeed(uint8_t seed) {
    state[1] = (state[1] & 0x3F) | (seed << 6);
}

// 상태 확인 함수들
bool Packet::isReady() const {
    return (state[0] & 0x80) != 0;
}

bool Packet::isGameStarted() const {
    return (state[0] & 0x40) != 0;
}

// 플레이어 번호를 반환 (Number 비트, 2비트: 4, 3번째 비트)
uint8_t Packet::getPlayerNumber() const {
    return (state[0] >> 3) & 0x03;
}

// 플레이어 번호 유효성 반환 (Valid 비트, 1비트: 5번째 비트)
bool Packet::isPlayerNumberValid() const {
    return (state[0] & 0x20) != 0;
}

bool Packet::hasItem() const {
    return (state[0] & 0x04) != 0;
}

bool Packet::isItemApplied() const {
    return (state[0] & 0x02) != 0;
}

bool Packet::getHp() const {
    return (state[0] & 0x01) != 0;
}

uint8_t Packet::getFacingDirection() const {
    return state[1] & 0x03;
}


uint8_t Packet::getObstacleSeed() const {
    return (state[1] >> 6) & 0x03;
}


void Packet::setKeyState(char key, bool isPressed) {
    uint8_t bitMask = 0;

    // 키에 따른 비트 매핑 (2~5번째 비트: W, A, D, C)
    switch (key) {
    case 'w': bitMask = 0x01; break; // W -> 2번째 비트
    case 'a': bitMask = 0x02; break; // A -> 3번째 비트
    case 'd': bitMask = 0x04; break; // D -> 4번째 비트
    case 'c': bitMask = 0x08; break; // C -> 5번째 비트
    default: return; // 유효하지 않은 키
    }

    bitMask <<= 2; // 2번째 비트부터 시작하도록 이동

    if (isPressed) {
        state[1] |= bitMask; // 눌린 상태 -> 비트 설정
    }
    else {
        state[1] &= ~bitMask; // 떼진 상태 -> 비트 해제
    }
}

bool Packet::getKeyState(char key) const {
    uint8_t bitMask = 0;

    switch (key) {
    case 'w': bitMask = 0x01; break;
    case 'a': bitMask = 0x02; break;
    case 'd': bitMask = 0x04; break;
    case 'c': bitMask = 0x08; break;
    default: return false; // 유효하지 않은 키
    }

    bitMask <<= 2; // 2번째 비트부터 시작하도록 이동
    return (state[1] & bitMask) != 0; // 비트가 1인지 확인
}